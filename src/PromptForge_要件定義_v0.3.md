# PromptForge 要件定義書（v0.3 / MVP）
**日付**: 2025-10-18（Asia/Tokyo）

---

## 1. 背景・目的
ローカルLLM（Ollama）を中心に、**プロンプトやコードを整形・要約・提案**する軽量ツールを提供する。  
Docker不要・完全ローカルで、**安全かつ再現性の高い**編集ループを実現する。

## 2. スコープ
- **インスコープ（MVP）**
  - 左右2ペイン編集／▶ 実行／⇧ 反映／コピー／保存
  - レシピ×フラグメント合成、Ollama呼び出し
  - `corpus/` のTXT読み込み（抜粋＋SHA）、`project/` のテキスト系ファイルI/O
  - Workspace自動保存/復元（アプリ再起動時）
  - Windows .bat 起動（dev/build/run）
- **アウトオブスコープ（MVP）**
  - ストリーミング応答、外部API連携、実行系・VCS連携、Monacoエディタ

## 3. ステークホルダー / ユーザー
- 主要ユーザー：プロンプト設計者、個人開発者、ローカルでLLM活用したいエンジニア
- 二次ユーザー：ドキュメント整形・仕様書作成者

## 4. 成果物
- 実行可能アプリ（Tauriビルド成果物）
- bat スクリプト群（dev/build/run/check）
- 仕様書、要件定義書、サンプルレシピ/フラグメント、サンプル`project/`ファイル

## 5. 前提条件 / 制約
- 環境：Windows 10/11、Node.js LTS、Rust（stable）、Ollama（ローカル）
- ネットワーク：`http://localhost:11434/*` のみ許可
- サンドボックス：`prompts/` `corpus/` `project/` 内のみ読み書き可
- 文字コード：UTF-8（BOMなし推奨）
- ファイルサイズ：TXT抜粋 `max_bytes=40,000` 既定（調整可）

## 6. 機能要件（Functional Requirements）
**FR-01** 左右2ペイン編集ができること（textareaベース）  
**FR-02** ▶ 実行で合成→Ollama呼び出し→右ペインへ反映できること  
**FR-03** 右ペインの**⇧ 反映**で左ペインに転送できること  
**FR-04** 各ペインでコピー/保存/別名保存が可能であること  
**FR-05** `project/` 内の `.py/.txt/.md/.json` を相対パス指定で**開く/保存**できること  
**FR-06** `.py` ファイル一覧（相対パス）が取得できること  
**FR-07** レシピ（YAML）とフラグメントを順に連結して最終プロンプトを合成できること  
**FR-08** `params` の `{{key}}` プレースホルダが展開されること  
**FR-09** ユーザー入力は**データ扱い**で末尾の `USER_INPUT` 区切りにそのまま挿入されること  
**FR-10** `corpus/` のTXTを読み込み、上限超過時は**抜粋（Head 75% + Tail 25%）**と**全文SHA-256**を提示できること  
**FR-11** 実行ログを `runs/<ts>/` に保存できること（レシピパス/最終プロンプト/応答RAW）  
**FR-12** Workspaceを**自動保存/復元**できること（左/右/レシピ/モデル/params/project_path）  
**FR-13** ショートカット：Ctrl/Cmd+Enter（実行）、Ctrl/Cmd+S（左保存）、Ctrl/Cmd+C（コピー）  
**FR-14** サンドボックス外のパス操作は拒否されること  
**FR-15** エラー時に分かりやすいメッセージを表示できること（Ollama疎通不可等）

## 7. 非機能要件（Non-Functional Requirements）
**NFR-01 可用性**：アプリの基本操作はオフラインで完結すること  
**NFR-02 性能**：1MB未満の入力での実行はUI応答が3秒以内（Ollamaの生成時間を除く）  
**NFR-03 信頼性**：異常終了後もWorkspaceから復元できること  
**NFR-04 保守性**：フラグメント/レシピは追加・差し替え容易であること（フォルダ差し替えで可）  
**NFR-05 セキュリティ**：外部FSアクセス禁止、HTTPスコープ固定、任意シェル実行禁止  
**NFR-06 監査性**：`runs/`により再現性が担保されること（SHA-256表示含む）  
**NFR-07 ポータビリティ**：Windowsを第一対象。将来macOS/Linuxへ拡張可能な構成  
**NFR-08 UX**：最小操作でループ（入力→実行→反映→保存）が回ること  
**NFR-09 i18n**：UIは日本語前提、英語化は将来対応（テキスト分離）

## 8. データ要件
- Workspace：v1スキーマ（JSON）  
- ログ：テキストファイル（UTF-8）  
- `project/`：テキストファイル（UTF-8推奨）

## 9. セキュリティ要件
- `ensure_under` によるサンドボックス確認（canonicalize + starts_with）  
- `project/` はテキスト拡張子に限定（誤保存対策）  
- TXT送信前の**機密マスク**（将来）を実装できる拡張点を確保

## 10. UX / アクセシビリティ
- ショートカット／ボタンに重複経路を用意  
- 押下アニメ・トースト等で状態把握を補助（将来）  
- 片側全画面化・フォントサイズ調整（将来）

## 11. 運用 / 保守
- 依存環境のアップデート時は**レシピ互換性**テストを実施  
- 例外ログ（Tauriのエラーログ）を利用し事象把握  
- バージョニング：仕様/要件/コードは同一タグで管理（例：v0.3）

## 12. リスクと軽減策
- R-01 応答遅延 → **ストリーミング**を次版で実装  
- R-02 破壊的変更 → **差分適用**モード導入（右→左の統制）  
- R-03 巨大ファイル → **選択範囲送信**／抜粋の導線を強化  
- R-04 誤保存 → サンドボックス＆拡張子制限、保存前の簡易Lint（将来）

## 13. 受け入れ基準（抜粋）
- [ ] 再起動で**左/右/レシピ/モデル/params/project_path**が復元される  
- [ ] `project/` への開く/保存が成功し、サンドボックス外アクセスは拒否  
- [ ] TXT抜粋＋SHAがUIで明示される  
- [ ] ▶ 実行→右反映→⇧ 反映で左へ戻る動線が一通り動作  
- [ ] `runs/<ts>/` にレシピ/プロンプト/応答が保存される  
- [ ] Ollama未起動時のエラーが明確

## 14. 成功指標（例）
- 初回起動から**最初の成功ループ**（入力→実行→反映→保存）まで1分以内  
- 日次で**3回以上のループ**を回すユーザー比率 > 60%（内製評価）

## 15. マイルストーン（参考）
- M1：MVP確定（本書）  
- M2：ストリーミング＋選択範囲送信  
- M3：タブ永続化＋Monaco（遅延ロード）  
- M4：差分モード＋JSONスキーマ検証

## 16. 将来拡張
- コーデモッドのPR生成（パッチ＋メッセージ雛形）  
- スライディング要約＋引用元リンクの提示  
- モデル別プリセット（System/Style差し替え）
